# Alembic Migration Guide

This document provides instructions for setting up and using Alembic for database migrations with SQLAlchemy.

## 1. Initial Setup

### 1.1 Installation
```bash
pip install alembic
```

### 1.2 Initialize Alembic
```bash
# Navigate to your project root (where you want alembic.ini to be created)
cd your_project_root
alembic init alembic
```

This creates:
- `alembic.ini`: Configuration file
- `alembic/`: Directory containing:
  - `env.py`: Environment configuration
  - `versions/`: Directory for migration scripts
  - `script.py.mako`: Template for migration scripts

### 1.3 Configure Database URL
Edit `alembic.ini`:
```ini
# Find and modify this line with your database URL
sqlalchemy.url = sqlite:///./your_database.db  # for SQLite
# or
sqlalchemy.url = postgresql://user:password@localhost/dbname  # for PostgreSQL
```

## 2. Mapping to SQLAlchemy Models

### 2.1 Update env.py
Edit `alembic/env.py` to import your SQLAlchemy models:

```python
import os
import sys
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool

from alembic import context

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Add your models directory to Python path
current_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(current_dir)
if parent_dir not in sys.path:
    sys.path.insert(0, parent_dir)

# Import your models (adjust the import path as needed)
from your_models_package.models import Base
target_metadata = Base.metadata
```

### 2.2 Model Structure Requirements
Your models should:
- Inherit from the same `Base` class
- Have `__tablename__` defined
- Use SQLAlchemy Column types
- Define relationships properly

Example:
```python
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
```

## 3. Executing Migrations

### 3.1 Generate Migration Script
```bash
# Generate a new migration
alembic revision --autogenerate -m "description_of_changes"

# Or generate an empty migration
alembic revision -m "description_of_changes"
```

### 3.2 Review Generated Migration
Always review the generated script in `alembic/versions/` before applying it.
The script will have:
- `upgrade()`: Changes to apply
- `downgrade()`: How to reverse changes

### 3.3 Apply Migrations
```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific number of migrations
alembic upgrade +2

# Rollback specific number of migrations
alembic downgrade -1

# Rollback all migrations
alembic downgrade base

# Get current revision
alembic current

# Show migration history
alembic history --verbose
```

### 3.4 Common Operations

#### Create New Tables
```python
def upgrade():
    op.create_table(
        'account',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('name', sa.String(50), nullable=False),
        sa.Column('description', sa.Unicode(200)),
    )
```

#### Add Column
```python
def upgrade():
    op.add_column('account', sa.Column('last_transaction_date', sa.DateTime))
```

#### Remove Column
```python
def upgrade():
    op.drop_column('account', 'last_transaction_date')
```

## 4. Best Practices

1. **Always Review Migrations**: Check autogenerated migrations before applying them.

2. **Version Control**: 
   - Include migration scripts in version control
   - Don't edit existing migrations that have been applied
   - Create new migrations for changes

3. **Testing**:
   - Test migrations on a copy of production data
   - Include both upgrade and downgrade testing
   - Verify data integrity after migration

4. **Backup**:
   - Always backup database before applying migrations
   - Have a rollback plan for each migration

5. **Maintenance**:
   - Regularly clean up old migrations
   - Document complex migrations
   - Keep migration history linear when possible

## 5. Troubleshooting

### Common Issues

1. **"Can't locate revision"**
   ```bash
   # Remove the database and existing migration scripts
   rm your_database.db
   rm -f alembic/versions/*.py
   
   # Generate fresh migration
   alembic revision --autogenerate -m "fresh_start"
   alembic upgrade head
   ```

2. **"Target database is not up to date"**
   ```bash
   # Check current revision
   alembic current
   
   # Show migration history
   alembic history --verbose
   ```

3. **Import Errors**
   - Verify Python path in `env.py`
   - Check model imports
   - Ensure `__init__.py` exists in model directories

   This is the key issue that I ran into setting up the alembic database. For some reason alembic must be able to discover the models.
   You can do this by adding the following to your __init__.py file:

   ```python
   from .models import Base, ObligorFacility, Obligor, ObligorProfile, Facility, FacilityProfile, RatingRecord, LrrRating, OrrRating

   __all__ = ['Base', 'ObligorFacility', 'Obligor', 'ObligorProfile', 'Facility', 'FacilityProfile', 'RatingRecord', 'LrrRating', 'OrrRating']
   ```
   Now it must done using relative imports. If you do `from models import *` it will not work.

## 6. Advanced Topics

### 6.1 Multiple Databases
```python
# in env.py
def run_migrations_online():
    engines = {
        'engine1': engine_from_config(...),
        'engine2': engine_from_config(...)
    }
    
    for name, engine in engines.items():
        with engine.connect() as connection:
            context.configure(
                connection=connection,
                target_metadata=target_metadata[name]
            )
            with context.begin_transaction():
                context.run_migrations(engine_name=name)
```

### 6.2 Branch Labels
```bash
# Create branch
alembic revision -m "branch_name" --branch-label branch_name

# Merge branches
alembic merge -m "merge_branches" branch1@head branch2@head
``` 